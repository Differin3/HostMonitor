# Nginx конфигурация для системы мониторинга
upstream api_backend {
    server 127.0.0.1:8000; # Python API master
}

upstream php_backend {
    server 127.0.0.1:9000; # PHP-FPM сокет/порт (настроить в php-fpm pool)
}

server {
    listen 80; # HTTP-порт
    server_name _; # можно заменить на реальный домен

    root /var/www/monitoring; # корень PHP-приложения (каталог с index.php)
    index index.php; # главный файл

    # Веб-интерфейс (PHP)
    location / {
        try_files $uri $uri/ /index.php?$query_string; # ЧПУ-маршрутизация
    }

    # PHP обработка через PHP-FPM
    location ~ \.php$ {
        include snippets/fastcgi-php.conf; # стандартные fastcgi-настройки
        fastcgi_pass php_backend; # backend PHP-FPM
    }

    # Статические файлы frontend
    location /frontend/ {
        alias /var/www/monitoring/frontend/; # каталог фронтенда
        expires 30d; # кэширование
        add_header Cache-Control "public, immutable"; # заголовки кэша
    }

    # API прокси на Python master
    location /api/ {
        proxy_pass http://api_backend/; # проксирование на API
        proxy_http_version 1.1; # HTTP версия
        proxy_set_header Host $host; # передаём Host
        proxy_set_header X-Real-IP $remote_addr; # реальный IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # цепочка прокси
        proxy_set_header X-Forwarded-Proto $scheme; # схема (http/https)
    }

    # WebSocket (если нужно)
    location /ws/ {
        proxy_pass http://api_backend/; # прокси на WebSocket-обработчик API
        proxy_http_version 1.1; # HTTP/1.1 для Upgrade
        proxy_set_header Upgrade $http_upgrade; # Upgrade заголовок
        proxy_set_header Connection "upgrade"; # Connection upgrade
        proxy_set_header Host $host; # Host заголовок
    }
}

